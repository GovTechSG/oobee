<%- include('./utilities') %>
<%- include('./itemCardRenderer') %>
<%- include('./pageAccordionBuilder') %>
<%- include('./constants') %>

<script>
  function expandRule(selectedCategory, selectedRule) {
    const conformanceLevels = {
      wcag2a: 'A',
      wcag2aa: 'AA',
      wcag21aa: 'AA',
      wcag22aa: 'AA',
      wcag2aaa: 'AAA',
    };

    const a11yRuleShortDescriptionMap = scanData?.a11yRuleShortDescriptionMap || {};
    const a11yRuleLongDescriptionMap = scanData?.a11yRuleLongDescriptionMap || {};
    const disabilityBadgesMap = scanData?.disabilityBadgesMap || {};

    // Set image based on WCAG criterion
    const imageElement = document.getElementById('expandedRuleImage');
    const imageContainer = document.getElementById('expandedRuleImageContainer');

    if (imageElement && imageContainer) {
      let imageSrc = null;

      // Get the first WCAG criterion from the rule's conformance
      if (selectedRule.conformance && selectedRule.conformance.length > 0) {
        const wcagConformance = selectedRule.conformance.filter(c => c.startsWith('wcag'));
        const wcagCriteriaLabels = scanData?.wcagCriteriaLabels || {};

        // Find the first matching WCAG criterion
        for (const wcag of wcagConformance) {
          const numbers = wcag.replace('wcag', '').split('');
          let formattedWcag = '';

          if (numbers.length === 3) {
            formattedWcag = `WCAG ${numbers[0]}.${numbers[1]}.${numbers[2]}`;
          } else if (numbers.length === 4) {
            formattedWcag = `WCAG ${numbers[0]}.${numbers[1]}.${numbers[2]}${numbers[3]}`;
          } else if (numbers.length === 5) {
            formattedWcag = `WCAG ${numbers[0]}.${numbers[1]}.${numbers.slice(2).join('')}`;
          }

          if (wcagCriteriaLabels[formattedWcag]) {
            // Try to get SVG from the map
            const svg = window.getWcagSvg ? window.getWcagSvg(formattedWcag) : null;
            if (svg) {
              imageSrc = window.svgToDataUrl ? window.svgToDataUrl(svg) : svg;
              break;
            }
          }
        }
      }

      // Hide image container if no SVG found, otherwise show it
      if (!imageSrc) {
        imageContainer.style.display = 'none';
      } else {
        imageContainer.style.display = 'flex';
        imageElement.src = imageSrc;
        imageElement.alt = selectedRule.description || 'Issue illustration';
      }
    }

    // Set title from a11yRuleShortDescriptionMap
    const titleElement = document.getElementById('expandedRuleName');
    if (titleElement) {
      const shortDescription = a11yRuleShortDescriptionMap[selectedRule.rule];
      titleElement.textContent = shortDescription || selectedRule.description || '';
    }

    // Set category badge
    const categoryBadge = document.getElementById('expandedRuleCategoryBadge');
    if (categoryBadge) {
      const categoryLabels = {
        mustFix: 'Must Fix',
        goodToFix: 'Good to Fix',
        needsReview: 'Manual Test',
        passed: 'Passed'
      };
      categoryBadge.textContent = categoryLabels[selectedCategory] || 'Must Fix';

      // Update badge class
      categoryBadge.className = 'mustfix-badge-label';
      if (selectedCategory === 'goodToFix') {
        categoryBadge.style.background = 'var(--strong-orange)';
        categoryBadge.style.borderColor = 'var(--strong-orange)';
      } else if (selectedCategory === 'needsReview') {
        categoryBadge.style.background = 'var(--very-dark-gray)';
        categoryBadge.style.borderColor = 'var(--very-dark-gray)';
      } else if (selectedCategory === 'mustFix') {
        categoryBadge.style.background = 'var(--light-carmine-pink)';
        categoryBadge.style.borderColor = 'var(--light-carmine-pink)';
      }
    }

    // Populate conformance badges
    const conformanceContainer = document.getElementById('expandedRuleConformance');
    if (conformanceContainer && selectedRule.conformance && selectedRule.conformance.length > 0) {
      const wcagConformance = selectedRule.conformance.filter(c => c.startsWith('wcag'));
      const wcagCriteriaLabels = scanData?.wcagCriteriaLabels || {};

      const criteriaNumbers = [];
      let level = null;

      wcagConformance.forEach(wcag => {
        const numbers = wcag.replace('wcag', '').split('');
        let formattedWcag = '';

        if (numbers.length === 3) {
          formattedWcag = `WCAG ${numbers[0]}.${numbers[1]}.${numbers[2]}`;
        } else if (numbers.length === 4) {
          formattedWcag = `WCAG ${numbers[0]}.${numbers[1]}.${numbers[2]}${numbers[3]}`;
        } else if (numbers.length === 5) {
          formattedWcag = `WCAG ${numbers[0]}.${numbers[1]}.${numbers.slice(2).join('')}`;
        }

        if (wcagCriteriaLabels[formattedWcag]) {
          criteriaNumbers.push(formattedWcag);
          if (!level) {
            level = wcagCriteriaLabels[formattedWcag];
          }
        }
      });

      const badges = criteriaNumbers.map(
        criteria => `<span class="conformance-badge">${criteria}</span>`,
      );

      if (level) {
        badges.push(`<span class="conformance-badge">Level ${level}</span>`);
      }

      conformanceContainer.innerHTML = badges.join('');
    }

    // Set long description from a11yRuleLongDescriptionMap
    const longDescriptionElement = document.getElementById('expandedRuleDescription');
    if (longDescriptionElement) {
      const longDescription = a11yRuleLongDescriptionMap[selectedRule.rule];
      longDescriptionElement.textContent = longDescription || whyItMatters[selectedRule.rule] || '';
    }

    // Populate disability impact
    const disabilitySection = document.getElementById('expandedRuleDisabilitySection');
    const disabilityMessage = document.getElementById('expandedRuleDisabilityMessage');
    const disabilities = disabilityBadgesMap[selectedRule.rule] || [];

    if (disabilityMessage && disabilities.length > 0) {
      let disabilityText = '';
      if (disabilities.length === 1) {
        disabilityText = `${disabilities[0]} Disability`;
      } else if (disabilities.length === 2) {
        disabilityText = `${disabilities[0]} and ${disabilities[1]} Disability`;
      } else {
        const disabilityList = [...disabilities];
        const lastDisability = disabilityList.pop();
        disabilityText = `${disabilityList.join(', ')} and ${lastDisability} Disability`;
      }

      disabilityMessage.innerHTML = `This issue prevents users with <span class="disability-text">${disabilityText}</span> from navigating your website.`;
      disabilitySection.style.display = 'block';
    } else {
      disabilitySection.style.display = 'none';
    }

    if (oobeeAiRules.includes(selectedRule.rule)) {
      document.querySelector('#expandedRuleAiFeedback').style.display = 'block';
    } else {
      document.querySelector('#expandedRuleAiFeedback').style.display = 'none';
    }

    const availableFixCategories = [];

    const itemsToUse = typeof filteredItems !== 'undefined' ? filteredItems : scanItems;

    Object.keys(itemsToUse).forEach(category => {
      const ruleInCategory = itemsToUse[category]?.rules?.find(r => r.rule === selectedRule.rule);

      if (ruleInCategory !== undefined && category !== 'passed') {
        if (category !== 'passed') {
          availableFixCategories.push(category);
        }

        // Automatically display content for the selected category
        if (category === selectedCategory) {
          document.getElementById('expandedRuleDropdownToggleCategoryInfo').innerText = `${ruleInCategory.totalItems} Total occ.`
          document.getElementById('expandedRuleDropdownTitle').innerText = `Pages with this issue (${ruleInCategory.pagesAffected.length})`
          buildExpandedRuleCategoryContent(category, ruleInCategory);
        }
      }
    });
  }
</script>
