<script>
  function buildExpandedRuleCategoryContent(category, ruleInCategory) {
    const contentContainer = document.getElementById('expandedRuleCategoryContent');
    const isCustomFlow = <%- isCustomFlow -%>;

    if (category === 'passed') {
      contentContainer.innerHTML = `You may find the list of passed HTML elements in <a href='./passed_items.json' target='_blank'>passed_items.json.txt</a>.`;
      return;
    }

    const accordionsList = createElementFromString(`<ul class="unbulleted-list"></ul>`);

    ruleInCategory.pagesAffected.forEach((page, index) => {
      const accordion = createPageAccordion(page, index, category, ruleInCategory, isCustomFlow);
      accordionsList.appendChild(accordion);
    });

    contentContainer.replaceChildren(accordionsList);
    hljs.highlightAll();
  }

  function createPageAccordion(page, index, category, ruleInCategory, isCustomFlow) {
    const accordionId = `${ruleInCategory.rule}-${category}-page-${index}`;
    const pageItemsCount = page.items.length || page.itemsCount || 0;
    const normalMode = page.itemsCount === undefined;

    const accordion = createElementFromString(`
      <li class="${normalMode ? '' : 'no-chevron'}">
        <div class="accordion mt-2 ${category}">
          <div class="accordion-item rule-modal-item">
            <div class="accordion-header" id="${accordionId}-title">
              ${normalMode ? '<button' : '<div'}
                aria-label="Page ${index + 1}: ${page.pageTitle}, ${pageItemsCount} ${pageItemsCount === 1 ? 'occurrence' : 'occurrences'}" 
                class="accordion-button collapsed"
                ${normalMode ? 'type="button"' : ''}
              >
                <span class="sr-only visually-hidden">${pageItemsCount} ${pageItemsCount === 1 ? 'occurrence' : 'occurrences'}</span>
                <svg
                  class="accordion-arrow"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M7.41 8.58984L12 13.1698L16.59 8.58984L18 9.99984L12 15.9998L6 9.99984L7.41 8.58984Z"
                    fill="#5735DF"
                  />
                </svg>
                <div class="me-3">${page.metadata ? page.metadata : page.pageTitle}</div>
                <div class="ms-auto rule-occurrence-count counter">${pageItemsCount} occ.</div>
              ${normalMode ? '</button>' : '</div>'}
            </div>
            <div id="${accordionId}-content" class="accordion-collapse collapse" aria-labelledby="${accordionId}-title">
              <div class="accordion-body p-3">
                ${isCustomFlow 
                  ? createCustomFlowContent(page)
                  : `<a href="${page.url}" target="_blank">${page.url}</a>`
                }
                <div class="page-accordion-content-title">
                  <span>${getFormattedCategoryTitle(category)} elements</span>
                  <span class="page-items-count">${pageItemsCount}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </li>
    `);

    if (normalMode) {
      setupPageAccordionHandlers(accordion, accordionId, category, ruleInCategory, page, index);
    }

    if (isCustomFlow) {
      setupCustomFlowScreenshot(accordion, page);
    }

    return accordion;
  }

  function createCustomFlowContent(page) {
    return `
      <div class="custom-flow-screenshot-container">
        <img alt="Screenshot of ${page.url}" src="${page.pageImagePath}" class="custom-flow-screenshot"/>
        <div><a href="${page.url}" target="_blank">${page.url}</a></div>
      </div>
    `;
  }

  function setupPageAccordionHandlers(accordion, accordionId, category, ruleInCategory, page, index) {
    const button = accordion.querySelector('button');

    // First click: Load content
    button.addEventListener('click', function loadContent(event) {
      const accordionBody = accordion.querySelector(".accordion-body");
      
      // Only build content if not already built
      if (!accordionBody.querySelector(".item-pagination-controls") && 
          !accordionBody.querySelector(".unbulleted-list")) {
        buildItemCardsWithPagination(accordionId, category, ruleInCategory, page, index);
        this.setAttribute('data-bs-target', '#' + accordionId + "-content");
        this.removeEventListener('click', loadContent);
        this.click();
      }
    });

    // Second click: Initialize Bootstrap collapse
    button.addEventListener('click', function initCollapse(event) {
      this.setAttribute('data-bs-toggle', 'collapse');
      this.setAttribute('data-bs-target', '#' + accordionId + "-content");
      this.setAttribute('aria-expanded', 'false');
      this.setAttribute('aria-controls', accordionId + "-content");
      
      new bootstrap.Collapse(this, { toggle: false });
      
      this.removeEventListener('click', initCollapse);
      setTimeout(() => {
        this.click();
      }, 0);
    });
  }

  function setupCustomFlowScreenshot(accordion, page) {
    const customScreenshotElem = accordion.getElementsByClassName('custom-flow-screenshot')[0];
    
    customScreenshotElem.onerror = function(event) {
      this.onerror = null;
      this.remove();
    };
    
    customScreenshotElem.onclick = function(event) {
      event.preventDefault();
      openLightbox(this.src, page.pageTitle, page.url);
    };
  }
</script>
