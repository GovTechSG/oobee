<script>
  (function populatePrioritiseIssues() {
    const issueDescriptionMap = {
      'area-alt': 'Add labels to clickable image areas',
      'aria-meter-name': 'All elements must have clear text to describe it',
      'aria-progressbar-name': 'Add labels to progress bars',
      'image-alt': 'Add alt text to images',
      'input-image-alt': 'Add alt text to image buttons',
      'object-alt': 'Add alt text to embedded content',
      'image-redundant-alt': 'Rewrite unhelpful image alt text',
      'role-img-alt': 'Add alt text to icon images',
      'svg-img-alt': 'Add alt text to vector images',
      'video-caption': 'Add captions to videos',
      'aria-required-children':
        'Add the required child elements for every accessibility (ARIA) role',
      'aria-required-parent': 'Add the required parent for every accessibility (ARIA) role',
      'definition-list': 'Group terms and definitions correctly',
      dlitem: 'Put terms and definitions in lists',
      list: 'Put list items inside lists',
      listitem: 'Place list items inside a list',
      'td-headers-attr': 'Reference headers within the same table',
      'th-has-data-cells': 'Connect table headers to cells',
      'autocomplete-valid': 'Use correct autocomplete values',
      'link-in-text-block': 'Make links look different from text beyond using color',
      'avoid-inline-spacing': 'Allow custom text spacing',
      'no-autoplay-audio': 'Disable auto-playing audio',
      'color-contrast': 'Increase contrast for readability',
      'frame-focusable-content': 'Let users tab into frames',
      'scrollable-region-focusable': 'Make scrollable regions keyboard friendly',
      'server-side-image-map': 'Replace server-side image maps',
      'meta-refresh-no-exceptions': 'Avoid timed refresh under 20 hours',
      blink: 'Remove blinking text',
      marquee: 'Remove scrolling text',
      bypass: 'Add a skip to content link',
      'document-title': 'Add a page title',
      'link-name': 'Add descriptive text to links',
      'target-size': 'All touch targets must have sufficient space',
      'html-has-lang': 'Set page language (lang)',
      'html-lang-valid': 'Fix invalid language',
      'html-xml-lang-mismatch': 'Make page language settings match',
      'valid-lang': 'Use valid language',
      'form-field-multiple-labels': 'Keep one label per field',
      'aria-allowed-attr': 'Remove inaccessible elements',
      'aria-braille-equivalent': 'Add nonâ€‘braille equivalent setting',
      'aria-command-name': 'Add text to interactive commands',
      'aria-conditional-attr': 'Use accessibility (ARIA) attributes for every element',
      'aria-deprecated-role': 'Remove outdated accessibility (ARIA) attributes',
      'aria-hidden-body': 'Remove hidden elements from page body',
      'aria-hidden-focus': "Don't hide elements that require keyboard focus",
      'aria-input-field-name': 'Add labels to custom inputs',
      'aria-prohibited-attr': 'Remove attributes not allowed here',
      'aria-required-attr': 'Add the required accessibility (ARIA) attributes',
      'aria-roles': 'Every accessibility (ARIA) role is a valid element',
      'aria-toggle-field-name': 'Add labels to toggle switches',
      'aria-tooltip-name': 'Add labels to tooltips',
      'aria-valid-attr': 'Use valid attribute names',
      'aria-valid-attr-value': 'Use valid attribute values',
      'button-name': 'Add text to buttons',
      'duplicate-id-aria': 'Make referenced IDs unique',
      'frame-title-unique': 'Give each frame a unique title',
      'frame-title': 'Add a title to frames',
      'input-button-name': 'Add text to input buttons',
      label: 'Label each form field',
      'nested-interactive': 'Avoid nested interactive controls',
      'oobee-accessible-label': 'Label clickable custom elements',
      'select-name': 'Name the select dropdown',
    };

    const wcagLinks = scanData?.wcagLinks || {};
    const wcagViolations = scanData?.wcagViolations || [];
    const wcagClauses = scanData?.wcagClauses || {};
    const mustFixRules = scanItems?.mustFix?.rules || [];

    // Format WCAG ID from "wcag111" to "WCAG 1.1.1"
    const formatWcagId = wcagId => {
      const numbers = wcagId.replace('wcag', '');
      let formatted = '';
      if (numbers.length === 3) {
        formatted = numbers.split('').join('.');
      } else if (numbers.length === 4) {
        formatted = numbers[0] + '.' + numbers[1] + '.' + numbers.slice(2);
      } else if (numbers.length === 5) {
        formatted = numbers[0] + '.' + numbers[1] + '.' + numbers.slice(2);
      }
      return 'WCAG ' + formatted;
    };

    const wcagCriteriaMap = new Map();

    mustFixRules.forEach(rule => {
      const ruleId = rule.rule;
      const wcagCriteria = rule.conformance?.filter(c => c.startsWith('wcag')) || [];

      wcagCriteria.forEach(wcag => {
        const formattedWcag = formatWcagId(wcag);

        if (!wcagCriteriaMap.has(formattedWcag)) {
          const clauseKey = formattedWcag.replace('WCAG ', '');
          wcagCriteriaMap.set(formattedWcag, {
            id: formattedWcag,
            name: wcagClauses[clauseKey] || formattedWcag,
            issues: [],
            totalIssueCount: 0,
          });
        }

        const criteria = wcagCriteriaMap.get(formattedWcag);
        const displayName = issueDescriptionMap[ruleId] || rule.description;

        criteria.issues.push({
          ruleId: ruleId,
          description: displayName,
          originalDescription: rule.description,
          totalItems: rule.totalItems || 0,
          helpUrl: rule.helpUrl || '',
          axeImpact: rule.axeImpact || '',
          conformance: rule.conformance || [],
          pagesAffected: rule.pagesAffected || [],
        });

        criteria.totalIssueCount = criteria.issues.length || 0;
      });
    });

    const sortedCriteria = Array.from(wcagCriteriaMap.values()).sort((a, b) => {
      if (a.totalIssueCount !== b.totalIssueCount) {
        return a.totalIssueCount - b.totalIssueCount;
      }
      return a.id.localeCompare(b.id);
    });

    const failedCriteria = sortedCriteria.filter(criteria =>
      wcagViolations.some(v => formatWcagId(v) === criteria.id),
    );

    const cardElement = document.getElementById('prioritiseIssuesCard');
    if (failedCriteria.length === 0) {
      if (cardElement) {
        cardElement.style.display = 'none';
      }
      return;
    }

    const accordionContainer = document.getElementById('prioritiseIssuesAccordion');
    if (!accordionContainer) return;

    const accordionHTML = failedCriteria
      .map((criteria, index) => {
        const wcagScore = criteria.id.replace('WCAG ', '');
        const issueWord = criteria.issues.length === 1 ? 'issue' : 'issues';

        const issuesListHTML = criteria.issues
          .map(issue => {
            // TODO: Get disability badges - placeholder for now, will be populated in future
            const disabilityBadges = `
              <div class="priority-issue-badges">
                <span class="disability-badge">Motor Disability</span>
                <span class="disability-badge">Visual Disability</span>
              </div>
            `;

            return `
              <li class="priority-issue-item d-flex g-one" data-rule-id="${issue.ruleId}">
                <div class="d-flex justify-content-between align-items-center w-90">
                    <div class="priority-issue-title">${issue.description}</div>
                    ${disabilityBadges}
                </div>
              </li>
            `;
          })
          .join('');

        return `
          <div class="accordion-item">
            <h4 class="accordion-header" id="heading${index}">
              <button
                class="accordion-button collapsed"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#collapse${index}"
                aria-expanded="false"
                aria-controls="collapse${index}"
              >
                <span class="h3">WCAG ${wcagScore} -&nbsp;</span>
                <span class="h3 fw-normal">${criteria.issues.length} ${issueWord}</span>
                <span class="wcag-score-badge">-1 WCAG Score</span>
                <svg class="accordion-icon-collapsed" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7.41 8.58984L12 13.1698L16.59 8.58984L18 9.99984L12 15.9998L6 9.99984L7.41 8.58984Z" fill="#5735DF"/>
                </svg>
                <svg class="accordion-icon-expanded" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M7.41 15.4102L12 10.8302L16.59 15.4102L18 14.0002L12 8.00016L6 14.0002L7.41 15.4102Z" fill="#5735DF"/>
                </svg>
              </button>
            </h4>
            <div
              id="collapse${index}"
              class="accordion-collapse collapse"
              aria-labelledby="heading${index}"
              data-bs-parent="#prioritiseIssuesAccordion"
            >
              <div class="accordion-body">
                <ul class="priority-issues-list">
                  ${issuesListHTML}
                </ul>
              </div>
            </div>
          </div>
        `;
      })
      .join('');

    accordionContainer.innerHTML = accordionHTML;

    document.querySelectorAll('.priority-issue-item').forEach(item => {
      item.addEventListener('click', function () {
        const ruleId = this.getAttribute('data-rule-id');

        document.querySelectorAll('.priority-issue-item').forEach(el => {
          el.classList.remove('active');
        });
        document.querySelectorAll('.priority-issue-title').forEach(el => {
          el.classList.remove('active');
        });

        this.classList.add('active');
        const title = this.querySelector('.priority-issue-title');
        if (title) {
          title.classList.add('active');
        }

        const allRules = [...mustFixRules];
        const selectedRule = allRules.find(r => r.rule === ruleId);

        if (selectedRule) {
          const category = mustFixRules.some(r => r.rule === ruleId) ? 'mustFix' : 'goodToFix';

          if (typeof expandRule === 'function') {
            expandRule(category, selectedRule);

            const offcanvasElement = document.getElementById('expandedRule');
            if (offcanvasElement) {
              const offcanvas = bootstrap.Offcanvas.getOrCreateInstance(offcanvasElement);
              offcanvas.show();
            }
          }
        }
      });
    });
  })();
</script>
