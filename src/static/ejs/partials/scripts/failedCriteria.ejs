<script>
  (function populateFailedCriteria() {
    const wcagLinks = scanData?.wcagLinks || {};
    const wcagViolations = scanData?.wcagViolations || [];
    const wcagClauses = scanData?.wcagClauses || {};

    // Convert wcagViolations format (e.g., "wcag111") to display format (e.g., "WCAG 1.1.1")
    const formatWcagId = wcagId => {
      const numbers = wcagId.replace('wcag', '');
      let formatted = '';
      if (numbers.length === 3) {
        formatted = numbers.split('').join('.');
      } else if (numbers.length === 4) {
        formatted = numbers[0] + '.' + numbers[1] + '.' + numbers.slice(2);
      } else if (numbers.length === 5) {
        formatted = numbers[0] + '.' + numbers[1] + '.' + numbers.slice(2);
      }
      return 'WCAG ' + formatted;
    };

    const failedCriteria = [];

    wcagViolations.forEach(violation => {
      const formattedId = formatWcagId(violation);

      const wcagInfo = wcagLinks[formattedId];

      if (wcagInfo) {
        const clauseKey = formattedId.replace('WCAG ', '');

        failedCriteria.push({
          id: formattedId,
          name: wcagClauses[clauseKey] || formattedId,
        });
      }
    });

    failedCriteria.sort((a, b) => {
      const aNum = a.id.replace('WCAG ', '').split('.').map(Number);
      const bNum = b.id.replace('WCAG ', '').split('.').map(Number);

      for (let i = 0; i < Math.max(aNum.length, bNum.length); i++) {
        if ((aNum[i] || 0) !== (bNum[i] || 0)) {
          return (aNum[i] || 0) - (bNum[i] || 0);
        }
      }
      return 0;
    });

    const countElement = document.getElementById('failedCriteriaCount');
    if (countElement) {
      countElement.textContent = failedCriteria.length;
    }

    const listElement = document.getElementById('failedCriteriaList');
    if (listElement && failedCriteria.length > 0) {
      const maxDisplay = 5;
      const displayCriteria = failedCriteria.slice(0, maxDisplay);

      const listHTML = displayCriteria
        .map(
          criteria => `
        <li class="d-flex justify-content-between">
          <span>${criteria.id} – ${criteria.name}</span>
        </li>
      `,
        )
        .join('');

      listElement.innerHTML = listHTML;

      // Show "View all" button if there are more than maxDisplay criteria
      if (failedCriteria.length > maxDisplay) {
        const viewAllButton = document.getElementById('viewAllFailedCriteria');
        if (viewAllButton) {
          viewAllButton.hidden = false;
          viewAllButton.onclick = () => {
            const allListHTML = failedCriteria
              .map(
                criteria => `
              <li class="d-flex justify-content-between">
                <span>${criteria.id} – ${criteria.name}</span>
              </li>
            `,
              )
              .join('');

            listElement.innerHTML = allListHTML;
            viewAllButton.hidden = true;
          };
        }
      }
    } else if (listElement) {
      listElement.innerHTML = '<p class="text-muted">No failed criteria found.</p>';
    }
  })();
</script>
